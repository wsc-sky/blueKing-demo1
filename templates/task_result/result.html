<%inherit file="/base.html"/>

<%block name="content">
<div class="container">
  <br/>

  <div class="king-block king-block-bordered">
    <div class="king-block-header king-gray-light">
      <h3 class="king-block-title">填写个人信息</h3>
    </div>
    <div class="king-block-content">
      选择业务

      <select id="business_select" name="select_job" class="select2_box" onchange="select_job()">
        <option value="all" class="selected_job" selected="true">所有</option>

        %for app in app_list:
        <option value=${app['ApplicationID']} class="selected_job">${app['ApplicationName']}</option>
        %endfor
      </select>

      选择用户

      <select id="select_user" name="select_user" class="select2_box" onchange="select_job()">
        <option value="all" class="selected_task" selected="true">所有</option>
        %for user in user_list:
        <option value=${user['username']} class="selected_job">${user['username']}</option>
        %endfor
      </select>
      任务类型


      <select name="select_task" id="select_task" class="select2_box">
        <option value="all" class="selected_task" selected="true">所有</option>
        %for task in task_list:
        <option value=${task['id']} class="selected_task">${task['name']}</option>
        %endfor

      </select>
      <button class="btn btn-success" onclick="filter_history()">过滤</button>
    </div>
  </div>
  <div class="king-block king-block-bordered">
    <div class="king-block-header king-gray-light">
      <h3 class="king-block-title">填写个人信息</h3>
    </div>

    <div class="king-block-content">
      <table class="table table-bordered table7_demo">
        <thead>
        <tr>
          <th>业务名称</th>
          <th>任务名称</th>
          <th>执行用户</th>
          <th>开始时间</th>
          <th>耗时</th>
          <th>IP</th>
          <th>操作</th>
        </tr>
        </thead>
        <tbody id="tr_data">
        % for history in history_list:
        <tr >

          <th>${history['app_name']}</th>
          <th>${history['task_name']}</th>
          <th>${history['user']}</th>
          <th>${history['created_date']}</th>
          <th>${history['totalTime']}</th>
          <th>${history['ip']}</th>
          <th >
            <button class="btn btn-primary" id="check_log"
                    onclick="check_log('${history['job_id']}')">
              查看执行Log
            </button>
          </th>
        </tr>
        %endfor

        </tbody>
      </table>
    </div>

  </div>
</div>

<script type="text/javascript">

    function check_log(job_id) {

        $.ajax({
            url: '/get_task_log/' + job_id.toString() + '/',
            type: 'GET',
            success: function (data) {
                var d = dialog({
                    width: 800,
                    title: "执行Log",
                    content: '<div style="white-space: \pre-wrap">' + data.log + '</div>',
                });
                d.show();
            }

        })

    }

    function filter_history(){
        var user = $("#select_user").val()
        var app_id = $("#business_select").val()
        var task_id = $("#select_task").val()
        $.ajax({
            url: '/filter_history/',
            type:'GET',
            data:{'user':user, 'app_id':app_id, 'task_id':task_id},
            success: function (data) {
              var history = data.history_list
                history_html = ''
                for (var i =0 ; i< history.length;i++){
                    var html =
                        "<tr>" +
                        "<th>"+history[i].app_name+"</th>" +
                        "<th>"+history[i].task_name+"</th>" +
                        "<th>"+history[i].user+"</th>" +
                        "<th>"+history[i].created_date+"</th>" +
                        "<th>"+history[i].totalTime+"</th>" +
                        "<th>"+history[i].ip+"</th>" +
                        "<th ><button class=\"btn btn-primary\" id=\"check_log\"" +
                        "     onclick=\"check_log('"+history[i].job_id+"')\">" +
                        "     查看执行Log" +
                        "     </button>" +
                        "</th>"
                    history_html+=html

                }
                $("#tr_data").html(history_html)            }

        })

    }

    function select_job() {
        var selected_business = $("#business_select").val();
        $.ajax({
            url: '/get_host_by_app/' + selected_business + '/',
            type: 'GET',
            success: function (data) {
            }
        })


    }


</script>


</div>

</%block>

